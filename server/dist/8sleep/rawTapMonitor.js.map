{"version":3,"file":"rawTapMonitor.js","sources":["8sleep/rawTapMonitor.ts"],"sourceRoot":"/","sourcesContent":["import { readdirSync, statSync, openSync, readSync, closeSync } from 'fs';\nimport { join } from 'path';\nimport cbor from 'cbor';\nimport moment from 'moment-timezone';\nimport logger from '../logger.js';\nimport settingsDB from '../db/settings.js';\nimport { updateDeviceStatus } from '../routes/deviceStatus/updateDeviceStatus.js';\nimport { DeviceStatus } from '../routes/deviceStatus/deviceStatusSchema.js';\nimport { DeepPartial } from 'ts-essentials';\nimport { Side } from '../db/schedulesSchema.js';\nimport { Gesture } from '../db/settingsSchema.js';\nimport { connectFranken } from './frankenServer.js';\nimport { executeFunction } from './deviceApi.js';\n\nconst RAW_FILE_PATH = '/persistent';\nconst POLL_INTERVAL_MS = 2000;\nconst MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB max file size to read\n// Read overlap to handle CBOR records that might span boundaries\n// CBOR records are typically small, 64KB overlap should be plenty\nconst READ_OVERLAP = 64 * 1024;\n\ninterface TapGestureEvent {\n  type: 'tap-gesture';\n  ts: number;\n  side: 'left' | 'right';\n  taps: number;\n}\n\nexport class RawTapMonitor {\n  private isRunning = false;\n  private lastProcessedTimestamp = 0;\n  private lastFileName = '';\n  private lastFileSize = 0; // Track file size for incremental reads\n  private initialized = false;\n\n  public async start() {\n    if (this.isRunning) {\n      logger.warn('RawTapMonitor is already running');\n      return;\n    }\n    this.isRunning = true;\n    logger.info('RawTapMonitor started');\n\n    // On startup, scan existing events to find the latest timestamp\n    // This prevents processing old events on restart\n    await this.initializeFromExistingEvents();\n\n    this.monitorLoop();\n  }\n\n  private async initializeFromExistingEvents() {\n    const rawFile = this.getLatestRawFile();\n    if (!rawFile) {\n      this.initialized = true;\n      return;\n    }\n\n    logger.info('[RawTapMonitor] Scanning existing events to find latest timestamp...');\n    const events = await this.readNewTapEvents(rawFile);\n\n    // Find the max timestamp from existing events\n    for (const event of events) {\n      this.lastProcessedTimestamp = Math.max(this.lastProcessedTimestamp, event.ts);\n    }\n\n    // Note: lastFileSize is already set by readNewTapEvents\n    logger.info(`[RawTapMonitor] Initialized: skipping ${events.length} existing events, lastTs=${this.lastProcessedTimestamp}, lastFileSize=${this.lastFileSize}`);\n    this.initialized = true;\n  }\n\n  public stop() {\n    this.isRunning = false;\n    logger.info('RawTapMonitor stopped');\n  }\n\n  private getLatestRawFile(): string | null {\n    try {\n      const files = readdirSync(RAW_FILE_PATH)\n        .filter(f => f.endsWith('.RAW') && !f.startsWith('SEQ'))\n        .map(f => ({\n          name: f,\n          path: join(RAW_FILE_PATH, f),\n          mtime: statSync(join(RAW_FILE_PATH, f)).mtime.getTime()\n        }))\n        .sort((a, b) => b.mtime - a.mtime);\n\n      return files.length > 0 ? files[0].path : null;\n    } catch (error) {\n      logger.error('Error finding RAW file:', error);\n      return null;\n    }\n  }\n\n  private async readNewTapEvents(filePath: string): Promise<TapGestureEvent[]> {\n    // Reset state if file changed\n    if (filePath !== this.lastFileName) {\n      logger.info(`[RawTapMonitor] RAW file changed: ${this.lastFileName} -> ${filePath}`);\n      this.lastProcessedTimestamp = 0;\n      this.lastFileSize = 0;\n      this.lastFileName = filePath;\n    }\n\n    try {\n      const fileStats = statSync(filePath);\n      const currentFileSize = fileStats.size;\n\n      if (currentFileSize > MAX_FILE_SIZE) {\n        logger.warn(`[RawTapMonitor] File too large (${currentFileSize} bytes), skipping`);\n        return [];\n      }\n\n      // Skip if file hasn't grown since last read (after initialization)\n      if (this.initialized && this.lastFileSize > 0) {\n        if (currentFileSize <= this.lastFileSize) {\n          return [];\n        }\n      }\n\n      // Read entire file - CBOR decoder needs to start from valid record boundary\n      // Partial reads starting mid-record corrupt decoder state\n      const buffer = Buffer.alloc(currentFileSize);\n      const fd = openSync(filePath, 'r');\n      try {\n        readSync(fd, buffer, 0, currentFileSize, 0);\n      } finally {\n        closeSync(fd);\n      }\n\n      // Update last file size after successful read\n      this.lastFileSize = currentFileSize;\n\n      // Decode CBOR records using streaming decoder\n      const events: TapGestureEvent[] = [];\n      const decoder = new cbor.Decoder();\n\n      decoder.on('data', (outer: { data?: Buffer }) => {\n        try {\n          if (outer && outer.data) {\n            const inner = cbor.decode(outer.data);\n            if (inner && inner.type === 'tap-gesture') {\n              if (inner.ts > this.lastProcessedTimestamp) {\n                events.push({\n                  type: 'tap-gesture',\n                  ts: inner.ts,\n                  side: inner.side,\n                  taps: inner.taps\n                });\n              }\n            }\n          }\n        } catch {\n          // Skip malformed inner records\n        }\n      });\n\n      decoder.on('error', () => {\n        // Ignore decoder errors (expected when reading from mid-record)\n      });\n\n      decoder.write(buffer);\n      try {\n        decoder.end();\n      } catch {\n        // Ignore end errors\n      }\n\n      if (events.length > 0) {\n        logger.debug(`[RawTapMonitor] Found ${events.length} new tap events in ${currentFileSize} bytes`);\n      }\n\n      return events;\n    } catch (error) {\n      logger.error('[RawTapMonitor] Error reading tap events:', error);\n      return [];\n    }\n  }\n\n  private mapTapsToGesture(taps: number): Gesture | null {\n    switch (taps) {\n      case 2: return 'doubleTap';\n      case 3: return 'tripleTap';\n      case 4: return 'quadTap';\n      default: return null;\n    }\n  }\n\n  private async vibrateAcknowledgment(side: Side) {\n    try {\n      await settingsDB.read();\n      const currentTime = moment.tz(settingsDB.data.timeZone);\n      const alarmTimeEpoch = currentTime.unix();\n\n      const alarmPayload = {\n        pl: 100,       // vibration intensity (100%)\n        du: 2,         // duration in seconds\n        pi: 'double',  // vibration pattern\n        tt: alarmTimeEpoch,\n      };\n\n      const cborPayload = cbor.encode(alarmPayload);\n      const hexPayload = cborPayload.toString('hex');\n      const command = side === 'left' ? 'ALARM_LEFT' : 'ALARM_RIGHT';\n\n      logger.debug(`[RawTapMonitor] Sending acknowledgment vibration on ${side}`);\n      await executeFunction(command, hexPayload);\n    } catch (error) {\n      logger.error('[RawTapMonitor] Error sending acknowledgment vibration:', error);\n    }\n  }\n\n  private async processGesture(side: Side, gesture: Gesture, pendingTemps: Map<Side, number>): Promise<void> {\n    try {\n      // Send acknowledgment vibration first\n      await this.vibrateAcknowledgment(side);\n\n      await settingsDB.read();\n      const behavior = settingsDB.data[side].taps[gesture];\n\n      if (behavior.type === 'temperature') {\n        // Use pending temp if we've already adjusted this side in this batch,\n        // otherwise fetch from device\n        let currentTemperatureTarget: number;\n        if (pendingTemps.has(side)) {\n          currentTemperatureTarget = pendingTemps.get(side)!;\n        } else {\n          const franken = await connectFranken();\n          const deviceStatus = await franken.getDeviceStatus(false);\n          currentTemperatureTarget = deviceStatus[side].targetTemperatureF;\n        }\n\n        let newTemperatureTargetF: number;\n        const change = behavior.amount;\n\n        if (behavior.change === 'increment') {\n          newTemperatureTargetF = currentTemperatureTarget + change;\n        } else {\n          newTemperatureTargetF = currentTemperatureTarget - change;\n        }\n\n        // Track the pending temperature for subsequent events in this batch\n        pendingTemps.set(side, newTemperatureTargetF);\n\n        logger.info(`[RawTapMonitor] Processing ${gesture} on ${side}: ${currentTemperatureTarget}°F -> ${newTemperatureTargetF}°F`);\n\n        await updateDeviceStatus({\n          [side]: { targetTemperatureF: newTemperatureTargetF }\n        } as DeepPartial<DeviceStatus>);\n      } else if (behavior.type === 'alarm') {\n        logger.info(`[RawTapMonitor] Alarm gesture detected on ${side}: ${behavior.behavior}`);\n        // TODO: Implement alarm handling\n      }\n    } catch (error) {\n      logger.error('[RawTapMonitor] Error processing gesture:', error);\n    }\n  }\n\n  private async monitorLoop() {\n    while (this.isRunning) {\n      try {\n        const rawFile = this.getLatestRawFile();\n\n        if (rawFile) {\n          const tapEvents = await this.readNewTapEvents(rawFile);\n\n          // Track pending temps for this batch to handle multiple events correctly\n          const pendingTemps = new Map<Side, number>();\n\n          for (const event of tapEvents) {\n            const gesture = this.mapTapsToGesture(event.taps);\n            if (gesture) {\n              logger.debug(`[RawTapMonitor] Detected ${gesture} on ${event.side} at ts=${event.ts}`);\n              await this.processGesture(event.side as Side, gesture, pendingTemps);\n            }\n            this.lastProcessedTimestamp = Math.max(this.lastProcessedTimestamp, event.ts);\n          }\n        }\n      } catch (error) {\n        logger.error('[RawTapMonitor] Error in monitor loop:', error);\n      }\n\n      await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL_MS));\n    }\n  }\n}\n\n// Singleton instance\nexport const rawTapMonitor = new RawTapMonitor();\n"],"names":[],"mappings":"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","debug_id":"94cae9c4-660c-5961-8b4a-1cc93e2765f7"}