{"version":3,"file":"deviceLabelWatcher.js","sources":["8sleep/deviceLabelWatcher.ts"],"sourceRoot":"/","sourcesContent":["import { watch, FSWatcher } from 'fs';\nimport { readFile, writeFile, access } from 'fs/promises';\nimport { constants } from 'fs';\nimport { exec } from 'child_process';\nimport { promisify } from 'util';\nimport logger from '../logger.js';\nimport { Version } from '../routes/deviceStatus/deviceStatusSchema.js';\n\nconst execAsync = promisify(exec);\n\n// Device label file paths (Pod 3 uses /deviceinfo/, Pod 4+ uses /persistent/deviceinfo/)\nconst DEVICE_LABEL_PATHS = [\n  '/persistent/deviceinfo/device-label',\n  '/deviceinfo/device-label',\n];\n\nclass DeviceLabelWatcher {\n  private watcher: FSWatcher | null = null;\n  private deviceLabelPath: string | null = null;\n  private isProcessing = false;\n\n  /**\n   * Start the device label watcher.\n   * Only activates for Pod 3 hub with Pod 4+ cover.\n   * @param coverVersion - The cover version detected from franken\n   */\n  async start(coverVersion: Version): Promise<void> {\n    // Only enable for Pod 4 or Pod 5 covers\n    const isPod4PlusCover = coverVersion === Version.Pod4 || coverVersion === Version.Pod5;\n    if (!isPod4PlusCover) {\n      logger.info(`Device label watcher not needed for cover version: ${coverVersion}`);\n      return;\n    }\n\n    // Find which path exists\n    for (const path of DEVICE_LABEL_PATHS) {\n      const exists = await access(path, constants.F_OK)\n        .then(() => true)\n        .catch(() => false);\n      if (exists) {\n        this.deviceLabelPath = path;\n        break;\n      }\n    }\n\n    if (!this.deviceLabelPath) {\n      logger.info('Device label file not found, skipping watcher');\n      return;\n    }\n\n    // Check if this is a Pod 3 hub (label starts with F in 3rd group)\n    const label = await readFile(this.deviceLabelPath, 'utf-8');\n    const parts = label.trim().split('-');\n    const hwRev = parts[2] || '';\n\n    // If already G or higher, no need to watch (unless Pod resets it)\n    if (!hwRev.startsWith('F')) {\n      logger.info(`Device label watcher: hub already at ${hwRev}, starting watch for resets`);\n    } else {\n      logger.info(`Starting device label watcher for Pod 3 hub (${hwRev}) with ${coverVersion} cover`);\n    }\n\n    // Check and fix on startup\n    await this.checkAndFixDeviceLabel();\n\n    // Watch for changes (in case Pod resets the label)\n    this.watcher = watch(this.deviceLabelPath, async (eventType) => {\n      if (eventType === 'change' && !this.isProcessing) {\n        logger.debug('Device label file changed, checking...');\n        await this.checkAndFixDeviceLabel();\n      }\n    });\n\n    this.watcher.on('error', (error) => {\n      logger.error('Device label watcher error:', error);\n    });\n  }\n\n  stop(): void {\n    if (this.watcher) {\n      this.watcher.close();\n      this.watcher = null;\n      logger.info('Device label watcher stopped');\n    }\n  }\n\n  private async checkAndFixDeviceLabel(): Promise<void> {\n    if (!this.deviceLabelPath || this.isProcessing) return;\n\n    this.isProcessing = true;\n    try {\n      const label = await readFile(this.deviceLabelPath, 'utf-8');\n      const trimmedLabel = label.trim();\n      const parts = trimmedLabel.split('-');\n\n      if (parts.length < 3) {\n        logger.warn(`Invalid device label format: ${trimmedLabel}`);\n        return;\n      }\n\n      const hwRev = parts[2];\n\n      // Check if 3rd group starts with 'F' (Pod 3 hub)\n      // We want to change it to 'G' to make it behave like Pod 4\n      if (hwRev.startsWith('F')) {\n        const newHwRev = 'G' + hwRev.slice(1);\n        parts[2] = newHwRev;\n        const newLabel = parts.join('-');\n\n        logger.info(`Updating device label from ${trimmedLabel} to ${newLabel}`);\n        await writeFile(this.deviceLabelPath, newLabel + '\\n');\n\n        // Restart the frank service to pick up the new label\n        await this.restartFrankService();\n      } else {\n        logger.debug(`Device label OK: ${trimmedLabel} (hw rev: ${hwRev})`);\n      }\n    } catch (error) {\n      logger.error('Error checking device label:', error);\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  private async restartFrankService(): Promise<void> {\n    try {\n      logger.info('Restarting frank service...');\n      await execAsync('sudo /bin/systemctl restart frank');\n      logger.info('Frank service restarted successfully');\n    } catch (error) {\n      logger.error('Failed to restart frank service:', error);\n    }\n  }\n}\n\n// Singleton instance\nexport const deviceLabelWatcher = new DeviceLabelWatcher();\n"],"names":[],"mappings":"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","debug_id":"de7a83d2-8571-5e1f-a0c0-e19022b91092"}